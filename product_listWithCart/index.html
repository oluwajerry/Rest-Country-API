<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product list</title>
    <link rel="stylesheet" href="index.css">
    <link rel="shortcut icon" href="images/favicon-32x32.png" type="image/x-icon">
</head>
<body>
    <main>
        <article class="container" id="top">
            <header>
                <h1 id="productTitle">Desserts</h1>
            </header>
            <section class="productListDisplay">
            </section>
        </article>
        <article class="cartSummary">
            <h3>Your Cart (<span id="cartNumber">0</span>)</h3>
            <figure class="emptyContent">
                <img src="images/illustration-empty-cart.svg" alt="empty cart">
                <figcaption>Your added items will appear here</figcaption>
            </figure>

            <article class="addedCartDetails">
                <section class="cartDetailsContainer">

                </section>
                <section class="orderSection">
                    <div class="order">
                        <p>Order Total</p>
                        <span id="totalAmount">$</span>    
                    </div> 
                    <figure>
                        <img src="./images/icon-carbon-neutral.svg" alt ="delivery icon">
                        <figcaption>This is a <b>carbon-neutral</b> delivery</figcaption>    
                    </figure>
                </section>
                <!-- <button id="confirmOrder"> -->
                    <a id="confirmOrder" href="#top">Confirm Order</a>
                <!-- </button> -->
            </article>
        </article>

         
        <article class="orderConfirmedContainer">
            <figure class="orderSuccessfulImg">
                <img src="images/icon-order-confirmed.svg" alt="">
            </figure>
            <figcaption class="orderText">
                <h1 class="confimation">Order Confirmed</h1>
                <p>We hope you enjoy your food!</p>
            </figcaption>
            <article class="sub-container">
                <section class="orderedProducts">

                </section>
                <section class="orderConfirmed">
                    <div class="order">
                        <p>Order Total</p>
                        <span id="totalAmount">$</span>    
                    </div>
                    <button id="resetToDefault">Start New Order</button> 
                </section>
            </article>
        </article>
        
    </main>
    <div id="overlay"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () =>{
            getJsonData()
            selectProductAndQuantity()
            
        })
        const getJsonData = async () =>{
            try {
                const jsonFile = await fetch('./data.json')
                const response = await jsonFile.json()
                printEachProduct(response)
            } catch (error) {
                console.error('Error:' + error)
            }
        }

        const printEachProduct = (data) =>{
            
            const productArticle = document.querySelector('.productListDisplay')

            let htmlContent = ''

            data.forEach(JsonObject => {
                const screenSize = window.innerWidth
                htmlContent += `
                <div class="productCards" data-name="${JsonObject.name}">
                    <figure>
                        <img src="${screenSize >= 768 ? JsonObject.image.desktop : JsonObject.image.mobile}" alt="product item">
                    </figure>
                    <figcaption class="add_To_Cart_container">
                        <img src="images/icon-add-to-cart.svg" alt="">
                        <p class="addToCart">Add to Cart</p>
                    </figcaption>
                    <figcaption class="addUpCart">
                         <span class="removeFromCart">
                            <img src="./images/icon-decrement-quantity.svg" alt = "decrement">    
                        </span>
                         <span class="numberOfItemAddedToCart">4</span>
                         <span class="increaseItemToBeAdded">
                            <img src="./images/icon-increment-quantity.svg" alt = "increment">    
                        </span>    
                    </figcaption>
                    <div class="productDetails">
                        <p>${JsonObject.category}</p>
                        <h5>${JsonObject.name}</h5>
                        <span id="price">$${JsonObject.price.toFixed(2)}</span>
                    </div>
                </div>
                `
                productArticle.innerHTML = htmlContent
            });
        }

        const cartItems = {}
        const selectProductAndQuantity = () =>{
            setTimeout(() => {
                const cartBtn = document.querySelectorAll('.add_To_Cart_container')

                cartBtn.forEach(btn => {
                    btn.addEventListener('click', (event) =>{
                        
                        btn.style.display = 'none'
                        btn.nextElementSibling.style.display = 'flex'
                        btn.nextElementSibling.style.backgroundColor = 'hsl(14, 86%, 42%)'
                        btn.previousElementSibling.style.border = '2px solid hsl(14, 86%, 42%)'
                        btn.previousElementSibling.style.borderRadius = '5px'
                        
                        let quantity = 1

                        const productCard = event.target.closest('.productCards') 
                        const productQuantity = productCard.querySelector('.numberOfItemAddedToCart')
                        const productName = productCard.querySelector('.productDetails h5').textContent
                        const productPrice = productCard.querySelector('.productDetails #price').textContent.slice(1)
                        productQuantity.textContent = quantity
                        
                        if(!cartItems[productName]){
                            cartItems[productName] = {
                                quantity: 1,
                                price: productPrice
                            }
                        }
                        
                        const increment = productCard.querySelector('.increaseItemToBeAdded')
                        increment.onclick = () => {
                            cartItems[productName].quantity++
                            productQuantity.textContent = cartItems[productName].quantity
                            updateCartDisplay()
                         }

                         const decrement = productCard.querySelector('.removeFromCart')
                         decrement.onclick = () => {
                            if(cartItems[productName].quantity > 1){
                                cartItems[productName].quantity--
                                productQuantity.textContent = cartItems[productName].quantity
                                updateCartDisplay()
                            }
                         }
                         updateCartDisplay()
                    })
                })
            }, 500);
        }

        const updateCartDisplay = () =>{
            const emptyContent = document.querySelector('.emptyContent')
            const addedCartDetails = document.querySelector('.addedCartDetails')
            const cartDetailsContainer = document.querySelector('.cartDetailsContainer')
            const totalProductQuantity = document.getElementById('cartNumber')
            const totalProductPrice = document.getElementById('totalAmount')

            if(Object.keys(cartItems).length > 0){
                emptyContent.style.display='none'
                addedCartDetails.style.display = 'block'

                let totalQuantity = 0
                let totalPrice = 0
                let cartHTML = ''

                Object.entries(cartItems).forEach(([name, item]) => {
                    cartHTML += `
                        <h4 class="productName">${name}</h4>
                        <section class="quantityPriceSection">
                            <div class="quantityPrice">
                                <span class="quantity">${item.quantity}x</span>
                                <span>@ ${item.price}</span>
                                <span class="totalPrice">$${(item.quantity * item.price).toFixed(2)}</span>    
                            </div>
                            <figure class="remove-item" data-name="${name}">
                                <img src="./images/icon-remove-item.svg" alt="remove-item">
                            </figure>    
                        </section>
                    `

                    totalQuantity += item.quantity

                    let calTotalPrice = Number(item.quantity * item.price)
                    totalPrice = totalPrice + calTotalPrice
                    
                })
                cartDetailsContainer.innerHTML = cartHTML
                totalProductQuantity.textContent = totalQuantity
                totalProductPrice.textContent = '$' + totalPrice.toFixed(2)


                const removeCartItems = document.querySelectorAll('.remove-item')
                removeCartItems.forEach(removeBtn => {
                    removeBtn.addEventListener('click', (event) => {
                        const itemName = event.currentTarget.dataset.name 
                        delete cartItems[itemName]
                        
                        const productCard = document.querySelector(`.productCards[data-name="${itemName}"]`)

                        if(productCard){
                            productCard.querySelector('.add_To_Cart_container').style.display = 'flex'

                            productCard.querySelector('.addUpCart').style.display = 'none'

                            productCard.querySelector('figure').style.border = 'none'
                        }

                        updateCartDisplay()
                    })
                })

            }
            else{
                emptyContent.style.display='block'
                addedCartDetails.style.display = 'none'
                totalProductQuantity.textContent = 0

            }

        }

       

        const confirmOrder = () => {
            const confirmOrders = document.getElementById('confirmOrder')
            confirmOrders.onclick = () =>{
                const orderConfirmedContainer = document.querySelector('.orderConfirmedContainer')
                const orderedProducts = document.querySelector('.orderedProducts') 
                const totalAmount = document.querySelector('.orderConfirmed #totalAmount')
                const overlay = document.getElementById('overlay');

                overlay.style.display = 'block';

                orderConfirmedContainer.style.display = 'block'
                
                orderHTML = ''
                let totalPrice = 0

                Object.entries(cartItems).forEach(([name, item]) => {
                    const productCard = document.querySelector(`.productCards[data-name="${name}"]`)
                    if (productCard) {
                        const image = productCard.querySelector('figure img')
                        const src = image.getAttribute("src")
                           orderHTML += `
                            <section class="quantityPriceSection">
                                <img src="${src}" alt="productImage">
                                <div class="quantityPrice">
                                    <h5>${name}</h5>
                                    <span class="quantity">${item.quantity}x</span>
                                    <span>@ ${item.price}</span>   
                                </div>    
                            </section>
                            <section>
                                <span class="totalPrice">$${(item.quantity * item.price).toFixed(2)}</span>  
                            </section>                          
                        `
                        
                        let calTotalPrice = Number(item.quantity * item.price)
                        totalPrice = totalPrice + calTotalPrice
                    }
                })
                orderedProducts.innerHTML = orderHTML
                totalAmount.textContent = '$' + totalPrice.toFixed(2)
            }
        }
        
        confirmOrder()
                    
        const resetToDefault = () =>{
            const backToDefault = document.getElementById('resetToDefault')
            backToDefault.onclick = () =>{
                const overlay = document.getElementById('overlay');
                const orderConfirmedContainer = document.querySelector('.orderConfirmedContainer')
                const emptyContent = document.querySelector('.emptyContent')
                const addedCartDetails = document.querySelector('.addedCartDetails')
                const totalProductQuantity = document.getElementById('cartNumber')

                overlay.style.display = 'none'
                addedCartDetails.style.display = 'none'
                orderConfirmedContainer.style.display = 'none'
                totalProductQuantity.textContent = 0
                emptyContent.style.display='block'
                getJsonData()
                location.reload();
            }
         }
         resetToDefault()
                
    </script>
</body>
</html>